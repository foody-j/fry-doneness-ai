# 튀김 조리 완료 판단 AI 시스템 아키텍처

## 개요

GMSL 카메라로 촬영된 튀김 조리 과정을 분석하여 조리 완료 시점을 예측하는 딥러닝 시스템

---

## 핵심 인사이트

### 데이터 특성

```
튀김이 기름에 잠김 → 튀김 안 보임, 기포만 보임
튀김을 들어올림 (탈탈) → 튀김이 명확히 보임 ⭐
```

### 조리 과정 타임라인

```
세션 시작
    │
    ▼
[대기] 튀김유만 보임
    │
    ▼
[투입] 로봇이 바트 투입
    │
    ▼
[조리중] 튀김 잠김, 기포만 보임
    │
    ├──▶ [1차 탈탈] 들어올림 → 털기 → 재투입 (튀김 보임!)
    │
    ▼
[조리중] 튀김 잠김, 기포만 보임
    │
    ├──▶ [2차 탈탈] 들어올림 → 털기 → 재투입 (튀김 보임!)
    │
    ▼
[조리중] 튀김 잠김, 기포만 보임
    │
    ├──▶ [3차 탈탈] 들어올림 → 털기 → 재투입 (튀김 보임!)
    │
    ▼
[배출] 완료
```

---

## 데이터 소스

| 데이터 | 튀김 보임? | 양 | 용도 |
|--------|-----------|-----|------|
| **탈탈 이미지** | O (명확) | 세션당 3~4장 | **정밀 판단** (메인) |
| **튀김유 이미지** | X (기포만) | 세션당 ~100장 | **연속 모니터링** (보조) |

---

## 시스템 구성

```
┌─────────────────────────────────────────────────────────────────┐
│                        입력 파이프라인                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  GMSL 카메라 (3초 간격)                                          │
│          ↓                                                      │
│  ┌─────────────────────────────────────────┐                    │
│  │        탈탈 시점 감지 (Lift Detection)   │                    │
│  │   바스켓이 올라온 프레임 자동 식별        │                    │
│  └─────────────────────────────────────────┘                    │
│          ↓                                                      │
│  ┌───────────────────┬───────────────────┐                      │
│  │   탈탈 이미지      │   튀김유 이미지    │                      │
│  │   (바스켓 올라옴)  │   (바스켓 잠김)    │                      │
│  │   세션당 3~4장    │   세션당 ~100장   │                      │
│  └───────────────────┴───────────────────┘                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      3-스트림 특징 추출                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ 탈탈 스트림  │  │ 기포 스트림  │  │ 튀김종류    │             │
│  │   (메인)    │  │   (보조)    │  │  (조건부)   │             │
│  ├─────────────┤  ├─────────────┤  ├─────────────┤             │
│  │EfficientNet │  │ 상대적 변화  │  │ Learnable   │             │
│  │    -B2      │  │   특징      │  │ Embedding   │             │
│  │             │  │             │  │             │             │
│  │ 튀김 색상   │  │ bubble_ratio│  │ 적어튀김    │             │
│  │ 튀김 질감   │  │ bubble_delta│  │ 돈까스      │             │
│  │ 황금색 비율 │  │ bubble_trend│  │ 치킨 ...    │             │
│  │             │  │ surface_calm│  │             │             │
│  │             │  │             │  │             │             │
│  │ 출력: 256d  │  │ 출력: 16d   │  │ 출력: 16d   │             │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │
│         │                │                │                     │
│         └────────────────┼────────────────┘                     │
│                          ↓                                      │
│                    Concatenate                                  │
│                      (288d)                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                       시계열 분석 (선택적)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  옵션 A: 단일 탈탈 이미지 (간단)                                  │
│  ┌─────────────────────────────────────────┐                    │
│  │  마지막 탈탈 이미지 1장 → FC layers     │                    │
│  └─────────────────────────────────────────┘                    │
│                                                                 │
│  옵션 B: 탈탈 시퀀스 (정확도 높음)                                │
│  ┌─────────────────────────────────────────┐                    │
│  │  [1차, 2차, 3차 탈탈] → Bi-LSTM        │                    │
│  │  색상 변화 패턴 학습                     │                    │
│  └─────────────────────────────────────────┘                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                          출력                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                    3단계 분류 (Softmax)                          │
│                                                                 │
│    ┌────────────┬─────────────────┬──────────────────┐          │
│    │ Class 0    │ Class 1         │ Class 2          │          │
│    │ 조리중     │ 거의완료        │ 완료             │          │
│    │            │                 │                  │          │
│    │ ~30초 전   │ 30~10초 전      │ 10초 전~완료     │          │
│    │            │                 │                  │          │
│    │ 알림 없음  │ 노란불          │ 빨간불 + 부저    │          │
│    └────────────┴─────────────────┴──────────────────┘          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 모델 상세

### 1. 탈탈 시점 감지 (Lift Detection)

바스켓이 올라온 프레임을 자동으로 식별

| 방법 | 설명 |
|------|------|
| 옵션 A | 간단한 CNN 분류기 (올라옴/잠김) |
| 옵션 B | 이미지 차이 기반 (급격한 변화 감지) |
| 옵션 C | 로봇 팔 감지 (바스켓 잡고 있는지) |

### 2. 탈탈 스트림 (메인)

| 항목 | 내용 |
|------|------|
| Backbone | EfficientNet-B2 |
| Pretrained | ImageNet |
| 입력 크기 | 224 x 224 x 3 |
| 출력 | 256-d feature vector |
| 학습 전략 | Frozen → Fine-tune (후반) |

**학습 대상:**
- 튀김 색상 변화 (밝은 베이지 → 황금빛 → 진한 갈색)
- 튀김 표면 질감
- 전체적인 조리 상태

### 3. 기포 스트림 (보조)

**핵심: 절대값이 아닌 상대적 변화 측정**

```python
# 튀김유는 재사용되므로 절대값은 의미 없음
# 세션 시작 대비 변화량으로 측정

bubble_features = {
    # 상대적 변화 (세션 시작 기준)
    'bubble_ratio': current / start,      # 1.0 → 0.3 (감소)
    'bubble_delta': start - current,      # 절대 감소량
    'bubble_trend': 최근_N프레임_추세,     # 감소 속도

    # 표면 상태
    'surface_calm': 표면_안정화_정도,      # 높을수록 완료 근접
    'motion_intensity': 프레임간_변화량,   # 낮을수록 완료 근접

    # 기타
    'bubble_size_avg': 평균_기포_크기,
    'bubble_count_norm': 정규화된_기포_수,
}
```

| 특징 | 조리 초반 | 조리 후반 |
|------|----------|----------|
| bubble_ratio | ~1.0 | ~0.3 |
| bubble_trend | 급격히 감소 | 완만/정체 |
| surface_calm | 낮음 | 높음 |
| motion_intensity | 높음 | 낮음 |

### 4. 튀김 종류 조건부 입력

**왜 필요한가?**
```
적어튀김 초반 색상 ≠ 돈까스 초반 색상
적어튀김 완료 색상 ≠ 치킨 완료 색상

→ 튀김 종류별로 "완료 상태"가 다름
→ 모델이 구분해서 학습해야 함
```

```python
product_types = {
    '적어튀김': 0,
    '돈까스': 1,
    '치킨': 2,
    '고구마튀김': 3,
    '튀김만두': 4,
    '생선까스': 5,
    '새우튀김': 6,
    # 확장 가능
}

# Learnable Embedding (원-핫보다 유연)
product_embedding = nn.Embedding(num_products, 16)
```

### 5. 시계열 모델 (선택적)

**옵션 A: 단일 이미지 (간단)**
```
마지막 탈탈 이미지 + 기포 특징 + 튀김 종류
    ↓
FC layers
    ↓
3단계 분류
```
- 장점: 단순, 빠름
- 단점: 변화 패턴 못 봄

**옵션 B: 탈탈 시퀀스 (권장)**
```
[1차 탈탈, 2차 탈탈, 3차 탈탈] 특징
    ↓
Bi-LSTM (2 layers)
    ↓
+ 기포 특징 + 튀김 종류
    ↓
3단계 분류
```
- 장점: 색상 변화 패턴 학습 (밝음→황금→갈색)
- 단점: 탈탈 3장 다 필요

---

## 학습 설정

### 데이터

| 항목 | 값 |
|------|-----|
| 탈탈 이미지 | 세션당 3~4장 |
| 튀김유 이미지 | 세션당 ~100장 (기포 특징 추출용) |
| 증강 | 회전, 밝기, 색상 지터, 수평 뒤집기 |

### 자동 라벨링

```
세션 끝 = 로봇 배출 = 완료 시점

완료_시점 = 세션 마지막 프레임 시간

for 탈탈_이미지 in 세션:
    if 마지막_탈탈:
        label = 2  # 완료
    elif 두번째_탈탈:
        label = 1  # 거의완료
    else:
        label = 0  # 조리중
```

### 하이퍼파라미터

| 항목 | 값 |
|------|-----|
| Optimizer | AdamW |
| Learning Rate | 1e-4 (backbone), 1e-3 (head) |
| Batch Size | 16~32 |
| Epochs | 50~100 |
| Loss | CrossEntropyLoss (class weight 적용) |
| Scheduler | CosineAnnealingLR |

---

## 추론 파이프라인

```
실시간 카메라 입력
        ↓
    3초마다 프레임 저장`
        ↓
┌───────────────────────────────────┐
│     탈탈 시점 감지                 │
│     바스켓 올라왔나?               │
└───────────────────────────────────┘
        │
        ├── No → 기포 특징만 업데이트 (보조)
        │
        └── Yes ↓
┌───────────────────────────────────┐
│     메인 추론                      │
│     탈탈 이미지 + 기포 + 튀김종류   │
│            ↓                      │
│     3단계 분류                     │
└───────────────────────────────────┘
        ↓
    결과에 따른 알림
    - Class 0: 알림 없음
    - Class 1: 노란불 (준비하세요)
    - Class 2: 빨간불 + 부저 (완료!)
```

---

## 디렉토리 구조 (예정)

```
dku_frying_ai/
├── CLAUDE.md                 # 프로젝트 컨텍스트
├── docs/
│   └── architecture.md       # 이 문서
├── data/
│   ├── raw/                  # 원본 데이터
│   │   └── pot1/
│   │       └── session_xxx/
│   ├── processed/            # 전처리된 데이터
│   │   ├── lift_images/      # 탈탈 이미지만 추출
│   │   └── bubble_features/  # 기포 특징 추출 결과
│   └── labels/               # 라벨 정보
├── src/
│   ├── data/                 # 데이터 로더
│   │   ├── lift_detector.py  # 탈탈 시점 감지
│   │   └── dataset.py        # PyTorch Dataset
│   ├── models/               # 모델 정의
│   │   ├── backbone.py       # EfficientNet
│   │   ├── temporal.py       # LSTM (선택적)
│   │   ├── bubble_features.py # 기포 특징 추출
│   │   └── frying_model.py   # 통합 모델
│   ├── training/             # 학습 코드
│   └── inference/            # 추론 코드
├── configs/                  # 설정 파일
├── scripts/                  # 유틸리티 스크립트
└── checkpoints/              # 모델 체크포인트
```

---

## 개발 우선순위

1. **탈탈 시점 감지** - 바스켓 올라온 프레임 자동 식별
2. **데이터 전처리** - 탈탈 이미지 추출, 기포 특징 추출
3. **베이스라인 모델** - 단일 탈탈 이미지 + 튀김 종류
4. **기포 특징 추가** - 상대적 변화 특징
5. **시계열 추가** - 탈탈 시퀀스 LSTM (선택적)
6. **학습/평가**
7. **Edge 배포** - TensorRT 최적화

---

## 하드웨어 요구사항

### 학습
- GPU: RTX 3080 이상 권장
- RAM: 32GB+
- Storage: 100GB+ (데이터)

### 추론 (Edge)
- Jetson Nano / Orin Nano
- 목표 추론 시간: < 500ms
- TensorRT 최적화 적용
